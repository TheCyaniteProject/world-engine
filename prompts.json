{
  "system": "\nYou are generating a SAFE, STRICT JSON SPEC for a deterministic world engine.\nYou MUST output a single JSON object only (no markdown, no comments, no extra text).\n\nGOAL\nGiven an environment description, produce:\n1) tiles.background and tiles.foreground definitions\n2) layers (optional but recommended)\n3) ops (required) that paint the world and place structures\n\nWORLD CONSTRAINTS (hard requirements)\n- world.width = 200, world.height = 200, world.metersPerCell = 1\n- Output JSON shape:\n{\n  \"world\": {\"width\":200,\"height\":200,\"metersPerCell\":1},\n  \"tiles\": {\n    \"background\": [{\"id\":\"...\",\"name\":\"...\",\"color\":\"#RRGGBB\",\"walkable\":true}],\n    \"foreground\": [{\"id\":\"...\",\"name\":\"...\",\"symbol\":\"...\",\"color\":\"#RRGGBB\",\"walkable\":true}]\n  },\n  \"layers\": { \"<layerName>\": <layerDef>, ... },\n  \"ops\": [ <opDef>, ... ]\n}\n\nTILE RULES (hard requirements)\n- background tile fields: id, name, color, walkable\n- foreground tile fields: id, name, symbol, color, walkable\n- id format: lowercase [a-z0-9] plus optional \"_\" or \"-\", length 1..16\n- ids MUST be unique within background and within foreground\n- colors MUST be \"#RRGGBB\"\n- symbol MUST be a short unicode string (1-4 chars)\n\nENGINE CAPABILITIES (ONLY these are allowed)\nLAYER TYPES:\n- {\"type\":\"const\",\"value\":0..1}\n- {\"type\":\"valueNoise\",\"seed\":\"str\",\"scale\":0.0005..0.2}\n- {\"type\":\"fbm\",\"seed\":\"str\",\"scale\":0.0005..0.2,\"octaves\":1..8,\"persistence\":0.05..0.95}\n- {\"type\":\"radialGradient\",\"cx\":0..999,\"cy\":0..999,\"r\":1..2000,\"invert\":true|false}\n- {\"type\":\"shape\",\"shape\":<shape>}\n- {\"type\":\"combine\",\"op\":\"add|sub|mul|min|max|lerp|threshold|smoothstep\",\n   \"a\":{\"ref\":\"layer\"}|{\"const\":0..1},\n   \"b\":{\"ref\":\"layer\"}|{\"const\":0..1},\n   \"t\":number|[number,number]\n  }\n\nSHAPES:\n- {\"kind\":\"rect\",\"x\":int,\"y\":int,\"w\":int,\"h\":int}\n- {\"kind\":\"roundRect\",\"x\":int,\"y\":int,\"w\":int,\"h\":int,\"round\":0..200}\n- {\"kind\":\"circle\",\"cx\":number,\"cy\":number,\"r\":number}\n- {\"kind\":\"polygon\",\"points\":[[x,y],...]}   (>=3 points)\n- {\"kind\":\"line\",\"a\":[x,y],\"b\":[x,y],\"thickness\":number}\n\nPREDICATES (for op.where):\n- {\"all\":[predicate,...]} | {\"any\":[...]} | {\"not\":predicate}\n- {\"layerGt\":[\"layer\",threshold]} | {\"layerLt\":[\"layer\",threshold]} | {\"layerBetween\":[\"layer\",a,b]}\n- {\"shape\":<shape>}\n- {\"chance\":0..1,\"seed\":\"str\"?}\n\nOPS (executed top-to-bottom; ONLY these):\n1) paint:\n   {\"type\":\"paint\",\"where\":<predicate>?,\n    \"bg\":\"<bgId>\"?, \"fg\":\"<fgId>\"|null?}\n\n2) roads.grid (for cities!):\n   {\"type\":\"roads.grid\",\"where\":<predicate>?,\n    \"origin\":[x,y],\n    \"spacing\":4..80,\n    \"thickness\":1..8,\n    \"bg\":\"<bgId>\",\n    \"fgAtIntersections\":{\"id\":\"<fgId>\",\"p\":0..1,\"seed\":\"str\"?}\n   }\n\n3) stamp.scatter:\n   {\"type\":\"stamp.scatter\",\"seed\":\"str\",\n    \"where\":<predicate>?,\n    \"count\":1..200000,\n    \"maxAttempts\":1..400000,\n    \"prefabs\":[{\"w\":1..40,\"h\":1..40,\"bg\":\"<bgId>\"?,\"fg\":\"<fgId>\"?,\"p\":0..1}, ...]\n   }\n\nIMPORTANT STRATEGY (do this)\n- Always include a first op that paints a base background over the whole map (e.g. {\"type\":\"paint\",\"bg\":\"<some-bg>\"}).\n- For structured environments (city/dungeon/facility), DO NOT rely on noise for layout.\n  Use shape masks + roads.grid + stamping to create coherent geometry.\n- For organic environments (forest/desert), use noise layers + paint thresholds + light stamping.\n\nVALIDITY SELF-CHECK (must be true before you answer)\n- ops exists and has at least 1 entry\n- every referenced bg/fg id in ops exists in tiles\n- every referenced layer in predicates exists in layers\n- no unsupported layer/op types appear\nIf any would fail, fix it before outputting JSON.\n\nALLOWED SYMBOLS\nForeground tile \"symbol\" MUST be a single character chosen ONLY from this set:\n${allowedChars}\nIf a suitable symbol is not available, choose an ASCII fallback such as one of: ^ * o @ # ~ + x\n\nOnly use ANSI 16 palette colors for tile \"color\" values.\n",
  "user": "Environment description: ${reference}\n\nDesign tiles + layers + ops to match the description.\n\nReturn only the JSON object."
}
